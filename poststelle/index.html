<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¨ FSA Poststelle ‚Äì Control & GitHub Push System</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#111b2e; --line:#1f2b44;
      --text:#e6f2ff; --muted:#9db4d6;
      --ok:#1ecb6c; --warn:#ffcb5c; --err:#ff5c5c;
      --card-shadow:0 8px 30px rgba(0,0,0,.35); --radius:12px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1220 0%,#09101d 100%);
      color:var(--text);
      font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
      display:flex;justify-content:center;padding:24px;
    }
    .container{
      max-width:1200px;width:100%;display:grid;
      grid-template-columns:2fr 1fr;grid-gap:20px;
    }
    h1{color:#38bdf8;margin-bottom:8px;text-align:center;}
    h2,h3{margin:0 0 8px;color:#e6f2ff}
    .panel{
      background:var(--panel);
      padding:18px;border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      margin-bottom:20px;
    }
    .muted{color:var(--muted)}
    .status-led{font-weight:700}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    .log{
      background:#0f1a2e;border:1px dashed #22365d;
      color:#9db4d6;padding:12px;border-radius:10px;
      white-space:pre-wrap;font-family:ui-monospace,Consolas;
      height:220px;overflow:auto;
    }
    footer{text-align:center;color:#93a8cc;font-size:12px;margin-top:10px;}
    button{
      border:none;padding:10px;border-radius:8px;cursor:pointer;
      font-weight:600;transition:.2s;min-width:160px;
    }
    button:hover{opacity:.9;transform:translateY(-1px);}
  </style>
</head>
<body>

  <!-- üî∏ Live Status Balken -->
  <div id="build-status" style="padding:10px; text-align:center; font-weight:bold; background:#0f1a2e; border-bottom:1px solid #1f2b44;">
    ‚è≥ Build-Status wird geladen ‚Ä¶
  </div>

  <div style="width:100%;">
    <h1>üì¨ FSA Poststelle ‚Äì Control & GitHub Push System</h1>
    <div class="container">
      <div>
        <!-- Token + Repo -->
        <div id="slot-token" class="panel"></div>

        <!-- Aktionen -->
        <div id="slot-patch" class="panel"></div>

        <!-- Log -->
        <div class="panel">
          <h2>üìú Live-Log</h2>
          <div id="log" class="log">Poststelle initialisiert ‚Ä¶</div>
        </div>
      </div>

      <!-- rechte Sidebar -->
      <div>
        <!-- üì¶ Backup Trigger -->
        <div id="slot-modules" class="panel">
          <h2>üß≠ Backup-System</h2>
          <p class="muted">Erstellt automatisch die stabile Fallback-Version der Poststelle im Repo.</p>
          <button onclick="deployBackup()">üì¶ Deploy Backup v1.0</button>
        </div>
      </div>
    </div>
    <footer>¬© 2025 FSA ¬∑ Poststelle v3.7.0 ¬∑ Slot-Architektur</footer>
  </div>

  <!-- Modular Scripts -->
  <script src="./js/log.js"></script>
  <script src="./js/healthcheck.js"></script>
  <script src="./js/token.js"></script>
  <script src="./js/actions.js"></script>
  <script src="./js/modules.js"></script>
  <script src="./js/init.js"></script>

  <!-- üõ∞Ô∏è Service Worker aktivieren -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker aktiv:', reg.scope))
        .catch(err => console.error('‚ùå Service Worker Fehler:', err));
    }
  </script>

  <!-- üõ∞Ô∏è Auto-Build Watcher -->
  <script>
    let lastBuildId = null;

    async function getLatestBuild() {
      const apiURL = `https://api.github.com/repos/Adler-FSA/Lp-Generator/actions/runs?per_page=1`;
      try {
        const res = await fetch(apiURL, {
          headers: typeof token !== "undefined" && token
            ? { "Authorization": `Bearer ${token}` }
            : {}
        });
        if (!res.ok) return;

        const data = await res.json();
        const lastRun = data.workflow_runs[0];
        if (!lastRun) return;

        const buildId = lastRun.id;
        const status = lastRun.status;
        const conclusion = lastRun.conclusion;

        // ersten Build merken
        if (lastBuildId === null) {
          lastBuildId = buildId;
          return;
        }

        // neuer Build erkannt
        if (buildId !== lastBuildId) {
          console.log(`üì¶ Neuer Build erkannt: ${buildId}`);
          lastBuildId = buildId;
          await waitForBuildToFinish(buildId);
          console.log("üü¢ Build abgeschlossen ‚Äî Seite wird neu geladen.");
          location.reload();
        }
      } catch (err) {
        console.error("‚ùå Build Watcher Fehler:", err);
      }
    }

    async function waitForBuildToFinish(buildId) {
      const apiURL = `https://api.github.com/repos/Adler-FSA/Lp-Generator/actions/runs/${buildId}`;
      let done = false;
      while (!done) {
        const res = await fetch(apiURL, {
          headers: typeof token !== "undefined" && token
            ? { "Authorization": `Bearer ${token}` }
            : {}
        });
        const data = await res.json();
        if (data.status === "completed") {
          done = true;
        } else {
          console.log("‚è≥ Build l√§uft noch‚Ä¶");
          await new Promise(r => setTimeout(r, 5000));
        }
      }
    }

    setInterval(getLatestBuild, 20000);
    document.addEventListener("DOMContentLoaded", getLatestBuild);
  </script>
</body>
</html>
