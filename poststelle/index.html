<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📮 FSA Poststelle v2.7.2 · Mega-Patch-Deploy</title>
<style>
  :root{
    --bg:#0b1220;--card:#111827;--ink:#e5e7eb;
    --muted:#94a3b8;--accent:#38bdf8;--ok:#10b981;--err:#ef4444;--btn:#2563eb;--btn2:#1f2937;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:40px auto;padding:0 16px}
  h1{font-size:1.8rem;margin:0 0 10px;color:var(--accent)}
  p.lead{margin:0 0 24px;color:var(--muted)}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:12px;padding:20px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type=password]{background:#0f172a;border:1px solid #1e293b;border-radius:8px;color:#fff;padding:10px 12px;font-size:1rem;min-width:260px}
  button{cursor:pointer;border:0;border-radius:8px;font-weight:700}
  .primary{background:var(--btn);color:#fff;padding:10px 14px}
  .ghost{background:var(--btn2);color:#cbd5e1;padding:8px 12px}
  .hint{font-size:.9rem;color:#8da0be;margin-top:8px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  pre#log{white-space:pre-wrap;background:#0f172a;border:1px dashed #334155;border-radius:8px;padding:12px;min-height:120px;max-height:380px;overflow:auto;margin-top:16px}
  .info{background:#0f172a;border:1px solid #1e293b;border-radius:10px;padding:14px;margin:16px 0;color:#cbd5e1}
  .info b{color:#e2e8f0}
  .footer{margin-top:18px;color:#64748b;font-size:.85rem}
  code{background:#0f172a;border:1px solid #1e293b;border-radius:6px;padding:0 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>📮 FSA Poststelle · Mega-Patch-Deploy <small style="font-weight:600;color:#7dd3fc">v2.7.2</small></h1>
  <p class="lead">Dieser Lauf installiert/aktualisiert den <b>Patch-Manager</b> (Werkstatt-Erweiterung) und legt ihn unter <code>/tools/patch-manager.html</code> und <code>/tools/js/patch-manager.js</code> ab.</p>

  <!-- Infofeld: Verantwortung -->
  <div class="info">
    <div><b>Arbeitsweise:</b> <br>
      Punkte <b>1–3 = du</b> (Start + Token + Klick) · Punkte <b>4–5 = System</b> (Poststelle + Werkstatt führen automatisch aus).
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="token" type="password" placeholder="Token eingeben …" />
      <button id="go" class="primary">🚀 Mega-Patch starten</button>
      <button id="btnLoad" class="ghost" title="aus URL übernehmen">🔄</button>
    </div>
    <div class="hint">Hinweis: Der Token wird <b>nicht gespeichert</b> – nur für diesen Deploy-Lauf verwendet.</div>

    <pre id="log">Log gestartet …</pre>
  </div>

  <div class="footer">FSA Poststelle · autonomer Deploy-Runner · Build v2.7.2</div>
</div>

<script>
/* ===== Utils ===== */
const OWNER  = "Adler-FSA";
const REPO   = "Lp-Generator";
const BRANCH = "main";
const apiBase = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;

const enc = s => btoa(unescape(encodeURIComponent(s)));
const $  = sel => document.querySelector(sel);
const log = (m, cls="") => {
  const el = $("#log");
  el.innerHTML += (cls ? `[${cls}] ` : "") + m + "\\n";
  el.scrollTop = el.scrollHeight;
};

async function getSha(path, token){
  const url = `${apiBase}/${path}?ref=${BRANCH}`;
  const res = await fetch(url, { headers:{ "Accept":"application/vnd.github+json","Authorization":"token "+token }});
  if(res.status===200){ const j = await res.json(); return j.sha; }
  if(res.status===404) return null;
  throw new Error("GET "+path+" -> "+res.status);
}

async function putFile(path, content, message, token){
  const sha = await getSha(path, token).catch(()=>null);
  const body = { message, content: enc(content), branch: BRANCH };
  if(sha) body.sha = sha;
  const res = await fetch(`${apiBase}/${path}`, {
    method:"PUT",
    headers:{ "Accept":"application/vnd.github+json","Authorization":"token "+token },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`PUT ${path} -> ${res.status} ${t}`);
  }
}

/* ===== Inhalte, die geschrieben werden ===== */

// HTML-Wrapper für Patch-Manager
const PATCH_HTML = `<!doctype html>
<html lang="de"><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>🧠 Patch-Manager · FSA Werkstatt</title>
  <style>
    body{margin:0;padding:28px;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto}
    .wrap{max-width:920px;margin:0 auto}
    a{color:#93c5fd}
    .muted{color:#94a3b8}
    .card{background:#111827;border:1px solid #1e293b;border-radius:12px;padding:18px;margin-top:16px}
  </style>
</head><body>
  <div class="wrap">
    <h1>🧠 Patch-Manager</h1>
    <p class="muted">Werkstatt-Erweiterung · lädt die Logik aus <code>/tools/js/patch-manager.js</code></p>
    <div id="app" class="card">Lade Patch-Manager …</div>
  </div>
  <script src="./js/patch-manager.js"></script>
</body></html>`;

// JS – Platzhalter/Starter für Patch-Manager
const PATCH_JS = `// Patch-Manager v2.6.x – Starter
(function(){
  const el = document.getElementById("app");
  const ui = document.createElement("div");
  ui.innerHTML = "<b>Patch-Manager geladen.</b><br><br>Hier folgen die Patches/Bedienelemente (wird in der Werkstatt weiter ausgebaut).";
  el.replaceChildren(ui);
})();`;

/* ===== Runner ===== */
async function run(){
  const input = $("#token");
  const btn   = $("#go");
  const token = (input.value || new URLSearchParams(location.search).get("token") || "").trim();
  if(!token){ alert("Bitte gültigen Token eingeben."); return; }

  btn.disabled = true; input.disabled = true;
  log("🟦 Starte Deploy …");

  try{
    log("✍️  HTML schreiben -> /tools/patch-manager.html");
    await putFile("tools/patch-manager.html", PATCH_HTML, "Add/Update Patch-Manager HTML wrapper", token);
    log("✅ HTML installiert: /tools/patch-manager.html","ok");

    log("✍️  JS schreiben -> /tools/js/patch-manager.js");
    await putFile("tools/js/patch-manager.js", PATCH_JS, "Add/Update Patch-Manager JS", token);
    log("✅ JS installiert: /tools/js/patch-manager.js","ok");

    log("🟩 Deploy abgeschlossen!");
    alert("Fertig ✅ Patch-Manager wurde installiert/aktualisiert.");
  }catch(e){
    log("🟥 Fehler: "+e.message,"err");
    alert("Fehler beim Deploy: "+e.message);
  }finally{
    btn.disabled = false; input.disabled = false;
  }
}

/* UI + Autoload aus URL */
$("#go").onclick = run;
(function(){
  const t = new URLSearchParams(location.search).get("token");
  if(t){ $("#token").value = t; $("#btnLoad").click(); }
})();
$("#btnLoad").onclick = ()=>log("🔑 Token übernommen.");
</script>
</body>
</html>
