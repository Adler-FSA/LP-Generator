<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FSA Poststelle · Auto-Deploy v2.8.7</title>
<style>
  :root{--bg:#0b1220;--panel:#0f1b2e;--muted:#96b0d4;--text:#e6f2ff;--ok:#26d97a;--err:#ff6464;--line:#163a6b;--round:12px;--shadow:0 8px 28px rgba(0,0,0,.25)}
  html,body{height:100%;background:linear-gradient(180deg,#09101d 0%,#0b1220 80%);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:900px;margin:32px auto;padding:24px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--round);box-shadow:var(--shadow);padding:20px 24px;margin-bottom:18px}
  h1{font-size:22px;margin:0 0 12px;display:flex;align-items:center;gap:10px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0b1830;color:var(--text)}
  button{background:#1e90ff;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  textarea{width:100%;min-height:160px;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b1830;color:var(--text);font-family:ui-monospace,monospace;font-size:13px}
  .muted{color:var(--muted);font-size:12px}
  .ok{color:var(--ok)} .err{color:var(--err)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>📮 FSA Poststelle · Auto-Deploy v2.8.7</h1>
    <div class="muted">Mit Werkstatt-Integration, Diagnose-Writer & DSGVO-safe AI-Patch-Import (ohne API-Keys).</div>
  </div>

  <div class="card">
    <label>Token eingeben …</label>
    <input id="token" type="password" placeholder="••••••••••••">
    <div class="btns">
      <button id="run">🚀 Mega-Patch starten</button>
      <button id="sync">📦 Werkstatt-Update einspielen</button>
    </div>
    <div id="aiInfo" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <label>Log</label>
    <textarea id="log" readonly>Log gestartet …</textarea>
  </div>
</div>

<script>
(function(){
  // ====== Repo-Konfiguration ======
  const OWNER="Adler-FSA", REPO="Lp-Generator", BRANCH="main";

  // ====== Helfer ======
  const $ = s=>document.querySelector(s);
  const log = (m)=>{ const el=$('#log'); el.value += (el.value?'\n':'')+m; el.scrollTop = el.scrollHeight; };
  const b64 = s => btoa(unescape(encodeURIComponent(s)));
  const ub64 = s => decodeURIComponent(escape(atob(s)));

  // ====== GitHub API (kompakt) ======
  const api = (path, method="GET", body=null, token=null)=>fetch(`https://api.github.com/repos/${OWNER}/${REPO}/${path}`,{
    method, headers:{
      "Accept":"application/vnd.github+json",
      ...(token?{"Authorization":"token "+token}:{})
    }, body: body?JSON.stringify(body):null
  });

  const getSha = async (path, token)=>{
    const r = await api(`contents/${path}?ref=${BRANCH}`,"GET",null,token);
    if(r.status===200){ const j=await r.json(); return j.sha; }
    return null;
  };

  const putFile = async (path, contentText, message, token)=>{
    const sha = await getSha(path, token);
    const body = { message, content: b64(contentText), branch: BRANCH, ...(sha?{sha}:{} ) };
    const r = await api(`contents/${path}`,"PUT", body, token);
    if(r.status>=200 && r.status<300) return true;
    const t = await r.text(); throw new Error(`PUT ${path} → ${r.status} ${t}`);
  };

  // ====== AI-Payload erkennen (aus gpt-bridge) ======
  const url = new URL(location.href);
  const aiParam = url.searchParams.get('ai'); // Base64 JSON
  let aiPayload = null;

  if(aiParam){
    try{
      aiPayload = JSON.parse(ub64(aiParam));
      $('#aiInfo').innerHTML = `AI-Patch erkannt → <b>${aiPayload.target_path}</b> (modus: <code>${aiPayload.mode}</code>). Wird beim Lauf committet.`;
      log('🧠 AI-Patch geladen …');
      log(JSON.stringify(aiPayload,null,2));
    }catch(e){
      log('❌ AI-Patch konnte nicht gelesen werden: '+e.message);
    }
  }else{
    $('#aiInfo').textContent = 'Kein AI-Patch übergeben.';
  }

  // ====== Lauf: Werkstatt-Update / Mega-Patch ======
  async function run(type){
    const token = ($('#token').value||'').trim();
    if(!token){ alert('Bitte gültigen Token eingeben.'); return; }
    const btn = type==="mega"?$('#run'):$('#sync');
    btn.disabled = true;
    try{
      log(type==="mega"?'🚀 Starte Mega-Patch …':'📦 Starte Werkstatt-Update …');

      // 1) Optional: AI-Patch als Datei ablegen (vor dem Rest)
      if(aiPayload){
        const name = `auto-init/ai-patch-${Date.now()}.json`;
        await putFile(name, JSON.stringify(aiPayload,null,2), `Add AI patch ${name}`, token);
        log(`✅ AI-Patch abgelegt → /${name}`);
      }

      // 2) Beispiel-Schreibvorgänge (HTML/JS) – hier minimaler Touch:
      await putFile("poststelle/index.html", document.documentElement.outerHTML, "Poststelle v2.8.7 auto-touch (confirm deploy)", token);
      log('✅ Poststelle bestätigt (auto-touch).');

      alert('Fertig ✅ – Lauf erfolgreich.');
    }catch(e){
      log('❌ Fehler: '+e.message);
      alert('Fehler beim Deploy: '+e.message);
    }finally{
      btn.disabled = false;
    }
  }

  $('#run').onclick = ()=>run("mega");
  $('#sync').onclick = ()=>run("sync");
})();
</script>
</body>
</html>
