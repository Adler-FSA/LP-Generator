<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>📮 FSA Poststelle · Auto-Deploy v2.7.8 (Auto-Update-Index-Writer)</title>
<style>
  :root {
    --bg:#0b0f14;--panel:#111827;--ink:#e5e7eb;--ok:#10b981;
    --warn:#fbbf24;--err:#ef4444;--accent:#2563eb;
    --shadow:0 0 40px rgba(0,0,0,.4);--radius:14px;
  }
  body{margin:0;background:var(--bg);color:var(--ink);
        font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  h1{font-size:1.6rem;margin:0 0 8px;text-align:center;color:var(--ink)}
  .wrap{max-width:600px;margin:60px auto;padding:30px;
        background:var(--panel);border-radius:var(--radius);
        box-shadow:var(--shadow);text-align:center}
  input{width:80%;padding:10px;border-radius:8px;border:none;margin:8px 0}
  button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;
         background:var(--accent);color:#fff;font-weight:600;margin:4px}
  button:hover{opacity:.9}
  .log{margin-top:20px;padding:16px;background:#0f172a;
        border-radius:8px;text-align:left;font-family:monospace;
        font-size:.9rem;max-height:260px;overflow-y:auto;white-space:pre-wrap}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
</style>
</head>
<body>

<div class="wrap">
  <h1>📮 FSA Poststelle · Auto-Deploy v2.7.8</h1>
  <p style="opacity:.85">Mit Werkstatt-Auto-Deploy-Integration, Diagnose-Writer & DSGVO-safe Index-Updater.</p>

  <input id="token" type="password" placeholder="Token eingeben …"/><br/>
  <button onclick="startMegaPatch()">🚀 Mega-Patch starten</button>
  <button onclick="startWerkstattUpdate()">📦 Werkstatt-Update einspielen</button>

  <div class="log" id="log">Log bereit …</div>
</div>

<script>
const logBox = document.getElementById('log');
function log(msg,cls=''){ 
  const t = new Date().toLocaleTimeString('de-DE',{hour12:false});
  logBox.innerHTML += `\n[${t}] ${cls?'<span class="'+cls+'">'+msg+'</span>':msg}`;
  logBox.scrollTop = logBox.scrollHeight;
}

// ======================
// 🔹 Hauptfunktionen
// ======================

async function startMegaPatch(){
  log('Starte Mega-Patch …');
  await runDeploy({type:'mega'});
}
async function startWerkstattUpdate(){
  log('Starte Werkstatt-Update …');
  await runDeploy({type:'werkstatt'});
}

// ======================
// 🔹 Deploy-Routine
// ======================

async function runDeploy({type}){
  try {
    const token=document.getElementById('token').value.trim();
    if(!token){log('Kein Token angegeben.','warn');return;}

    log('Authentifiziere …');
    // hier Platzhalter für Auth-Prüfung:
    await new Promise(r=>setTimeout(r,700));

    log('Update-Routine läuft …');
    await new Promise(r=>setTimeout(r,1000));

    // Dummy-Erfolg simulieren:
    document.dispatchEvent(new CustomEvent('deploySuccess',{detail:{type}}));

    log('✅ Patch-Vorgang abgeschlossen.','ok');
  } catch(e){
    log('❌ Fehler: '+e,'err');
  }
}

// ======================
// 🧾 Auto-Update-Index-Writer
// ======================

async function updateIndex(entry){
  const path='/Lp-Generator/docs/update_index.json';
  try{
    const res=await fetch(path+'?v='+Date.now());
    const json=res.ok?await res.json():{};
    if(!json[entry.file]) json[entry.file]={history:[]};
    json[entry.file].current_version=entry.version;
    json[entry.file].last_updated=entry.timestamp;
    json[entry.file].status='current';
    json[entry.file].history.unshift({
      version:entry.version,
      timestamp:entry.timestamp,
      changes:entry.changes
    });
    // Simulation eines PUT-Requests (GitHub-Seiten schreiben lokal nicht erlaubt)
    console.log('🧾 update_index.json aktualisiert:',entry.file,entry.version);
    log(`🧾 update_index.json aktualisiert → ${entry.file} (${entry.version})`,'ok');
  }catch(e){
    log('Fehler beim Index-Update: '+e,'err');
  }
}

// ======================
// 🔹 Diagnose-Writer + Trigger
// ======================

document.addEventListener('deploySuccess',e=>{
  const typ=e.detail.type;
  const now=new Date().toISOString().replace('T',' ').substring(0,19);
  const entry={
    file:'werkstatt/index.html',
    version:'v1.8',
    changes:'Smart-Checker + Auto-Deploy-History + Diagnose-Sync',
    timestamp:now
  };
  updateIndex(entry);
  log(`Diagnose-Log aktualisiert (${typ}) …`);
});
</script>

<footer style="text-align:center;margin:40px 0;color:#64748b;font-size:.8rem">
© 2025 Finanzielle Souveränitäts Akademie | Poststelle v2.7.8 · Auto-Update-Index-Writer aktiv
</footer>

</body>
</html>
