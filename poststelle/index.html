<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FSA Poststelle v2.8.5 · Auto-Docs</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111b2e;--line:#1e2a3f;--ok:#22c55e;--warn:#fbbf24;--err:#ef4444;
      --text:#dbe3f4;--muted:#90a0bd;--accent:#3b82f6;--shadow:0 8px 30px rgba(0,0,0,.35);
      --card: #0f172a;
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0d1630);color:var(--text);
         font:14px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;}
    .wrap{max-width:880px;margin:32px auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:22px;box-shadow:var(--shadow)}
    h1{margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);margin:0 0 16px}
    label{display:block;margin:14px 0 6px}
    input[type=text],input[type=password]{
      width:100%;padding:12px 14px;border-radius:8px;border:1px solid var(--line);background:#0c1527;color:var(--text)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      background:var(--accent);border:1px solid #234a9c;color:#fff;padding:10px 14px;border-radius:8px;
      cursor:pointer;box-shadow:var(--shadow)
    }
    button.sec{background:#0d1a33;border-color:var(--line);color:var(--text)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#0e1b34;border:1px solid var(--line);
           padding:8px 10px;border-radius:10px;margin-top:12px}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
         white-space:pre-wrap;background:#0a1326;border:1px dashed var(--line);color:#c9d6ff;
         padding:14px;border-radius:12px;margin-top:14px;max-height:320px;overflow:auto}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .footer{margin-top:22px;color:var(--muted);font-size:12px;text-align:center}
    .mini{font-size:12px;color:var(--muted)}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>📮 FSA Poststelle v2.8.5 · Auto-Docs</h1>
      <p class="sub">Schreibt/aktualisiert <code>/manifest.txt</code> und <code>/docs/update_index.json</code> über die GitHub-API. DSGVO-safe: keine Tokens oder PII persistent.</p>

      <div class="badge">
        <div>🔐 Token nur für *diesen Lauf* verwenden (wird nicht gespeichert).</div>
      </div>

      <label for="token">Token eingeben …</label>
      <input id="token" type="password" placeholder="ghp_…">

      <div class="row">
        <button id="run" title="Manifest + Update-Index schreiben">📝 Auto-Docs ausführen</button>
        <button id="test" class="sec" title="Seiten neu laden ohne Cache">🔎 Testlinks öffnen</button>
        <button id="openManifest" class="sec" title="Manifest öffnen (wenn vorhanden)">📜 Manifest öffnen</button>
      </div>

      <div class="log" id="log">Log gestartet …</div>

      <p class="mini">
        Testlinks: 
        <a id="lnkPoststelle" target="_blank" rel="noopener">Poststelle (nocache)</a> ·
        <a id="lnkWerkstatt"  target="_blank" rel="noopener">Werkstatt (nocache)</a> ·
        <a id="lnkTemplate"   target="_blank" rel="noopener">LP-Template (nocache)</a>
      </p>
    </div>

    <div class="footer">
      © 2025 Finanzielle Souveränitäts Akademie · Poststelle v2.8.5 (Auto-Docs) · Web 4.0 Proof of Vision
    </div>
  </div>

<script>
(async function(){
  // ===== Repo-Kontext anpassen, falls nötig =====
  const OWNER = "Adler-FSA";
  const REPO  = "Lp-Generator";
  const BRANCH= "main";

  const $ = (sel)=>document.querySelector(sel);
  const logEl = $("#log");
  const log = (m)=>{ logEl.textContent += "\\n" + m; logEl.scrollTop = logEl.scrollHeight; };

  // Testlinks mit nocache param
  const nocache = ()=> `?nocache=${Date.now()}`;
  $("#lnkPoststelle").href = `https://adler-fsa.github.io/Lp-Generator/poststelle/${nocache()}`;
  $("#lnkWerkstatt").href  = `https://adler-fsa.github.io/Lp-Generator/werkstatt/${nocache()}`;
  $("#lnkTemplate").href   = `https://adler-fsa.github.io/Lp-Generator/lp-template.html${nocache()}`;

  $("#openManifest").onclick = ()=> window.open(`https://adler-fsa.github.io/Lp-Generator/manifest.txt${nocache()}`,'_blank');

  // ---- GitHub API helpers ----
  const gh = (token)=>({
    async get(path){
      const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/${path}`,{
        headers:{Accept:"application/vnd.github+json","Authorization":"token "+token}
      });
      return r;
    },
    async getSha(path){
      const r = await this.get(`contents/${path}?ref=${BRANCH}`);
      if(r.status===200){ const j=await r.json(); return j.sha; }
      return null;
    },
    async putFile(path, content, message, token){
      const sha = await this.getSha(path);
      const body = {
        message, branch:BRANCH,
        content: btoa(unescape(encodeURIComponent(content))),
        ...(sha?{sha}:{})
      };
      const r = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`,{
        method:"PUT",
        headers:{Accept:"application/vnd.github+json","Authorization":"token "+token},
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const t = await r.text();
        throw new Error(`PUT ${path} → ${r.status}: ${t}`);
      }
      return await r.json();
    },
    async appendLog(path, line, token){
      // simple append: read current, append line, write back (best-effort)
      let curr = "";
      const res = await this.get(`contents/${path}?ref=${BRANCH}`);
      if(res.status===200){
        const j = await res.json();
        curr = decodeURIComponent(escape(atob(j.content)));
      }
      const now = new Date().toISOString().replace('T',' ').replace('Z','');
      const next = (curr?curr+"\\n":"") + `[${now}] ${line}`;
      return this.putFile(path, next, "diagnose-log append", token);
    }
  });

  // ---- Generierer: Manifest & Update-Index ----
  function buildManifest(){
/*
  Manifest – entsteht/aktualisiert sich bei jedem Auto-Docs Lauf.
  Kein Personenbezug, nur System-Metadaten und die Vision in Klartext.
*/
return `FSA Manifest · Vision 4.0
────────────────────────────────────────
Diese Datei beschreibt Ursprung, Zweck und Funktionsprinzip
des dezentralen, token-gesteuerten FSA Update-Systems.

Leitgedanke:
• Bildung, Verantwortung, Selbstbestimmung
• Werkzeuge statt Abhängigkeiten
• Von Mensch zu Mensch (Peer-to-Peer), ohne zentrale Instanzen
• Globale, transparente Steuerung (Web 4.0 Ready)

Systemreferenzen:
• Poststelle v2.8.5 (Auto-Docs aktiv)
• Werkstatt (Zentrale) · Diagnose/History/Sync
• WhiteLabel Kernel · LP-Template Steuerung

Integrität:
• DSGVO-safe Betriebsmodus (kein PII-Storage)
• Nur explizite Token-Läufe schreiben ins Repo
• Alle Änderungen mit Commit-Historie nachvollziehbar

Letzte Aktualisierung: ${new Date().toLocaleString('de-DE')}
────────────────────────────────────────
`;
  }

  function normalizeIndex(prev){
    try{
      const j = JSON.parse(prev);
      return j && typeof j==='object' ? j : { pages:[] };
    }catch(_){ return { pages:[] }; }
  }

  async function writeUpdateIndex(api, token){
    const path = "docs/update_index.json";
    // Bestehenden Index holen
    let prevRaw = "{}";
    const r = await api.get(`contents/${path}?ref=${BRANCH}`);
    if(r.status===200){
      const j = await r.json();
      prevRaw = decodeURIComponent(escape(atob(j.content)));
    }
    const idx = normalizeIndex(prevRaw);

    // Ein Beispiel-Eintrag für die Kernseiten (du kannst beliebig erweitern)
    const stamp = new Date().toISOString();
    const ensure = (file, versionTag, url)=> {
      const key = file;
      let e = idx.pages.find(p=>p.file===key);
      const base = { file:key, url, version:versionTag, updated_at: stamp };
      if(e){ e.version=versionTag; e.updated_at=stamp; e.url=url; }
      else { idx.pages.push(base); }
    };

    ensure("poststelle/index.html","v2.8.5", "https://adler-fsa.github.io/Lp-Generator/poststelle/");
    ensure("werkstatt/index.html","v1.9+",   "https://adler-fsa.github.io/Lp-Generator/werkstatt/");
    ensure("lp-template.html","v2.4.2+ Patches", "https://adler-fsa.github.io/Lp-Generator/lp-template.html");

    const content = JSON.stringify(idx,null,2);
    await api.putFile(path, content, "update_index.json aktualisiert (Auto-Docs)", token);
  }

  async function writeManifest(api, token){
    const content = buildManifest();
    await api.putFile("manifest.txt", content, "manifest.txt aktualisiert (Auto-Docs)", token);
  }

  // ---- Runner ----
  $("#run").onclick = async ()=>{
    const token = ($("#token").value || new URLSearchParams(location.search).get("token") || "").trim();
    if(!token){ alert("Bitte gültigen Token eingeben."); return; }
    $("#run").disabled = true;

    try{
      log("🔧 Initialisiere Auto-Docs …");
      const api = gh(token);
      await writeManifest(api, token);
      log("📜 Manifest geschrieben → /manifest.txt");
      await writeUpdateIndex(api, token);
      log("🗂️ Update-Index geschrieben → /docs/update_index.json");
      await api.appendLog("docs/diagnose_log/FSA_DIAGNOSE_LOG.txt","Auto-Docs Lauf erfolgreich (manifest/index)", token);
      log("✅ Fertig – Auto-Docs erfolgreich abgeschlossen.");
      alert("Fertig ✅ Manifest & Update-Index wurden aktualisiert.");
    }catch(e){
      log("❌ Fehler: "+e.message);
      alert("Fehler bei Auto-Docs: "+e.message);
    }finally{
      $("#run").disabled = false;
    }
  };

  $("#test").onclick = ()=>{
    window.open($("#lnkPoststelle").href,'_blank');
    window.open($("#lnkWerkstatt").href,'_blank');
    window.open($("#lnkTemplate").href,'_blank');
  };

  // URL-Token transfer (quality-of-life)
  const urlToken = new URLSearchParams(location.search).get("token");
  if(urlToken) $("#token").value = urlToken;
})();
</script>
</body>
</html>
