<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FSA â€¢ Media Admin (JSON Editor)</title>
<style>
  :root{
    --bg:#0b0f19; --panel:#121829; --ink:#e8eefc; --muted:#9fb0c7;
    --accent:#d4af37; --ok:#15c377; --err:#ff6b6b; --border:1px solid rgba(255,255,255,.08);
    --radius:12px;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:16px 24px;position:sticky;top:0;background:#0b0f19cc;backdrop-filter:blur(6px);border-bottom:var(--border)}
  h1{margin:0;font-size:1.2rem;letter-spacing:.3px}
  main{max-width:1100px;margin:22px auto;padding:0 20px 40px}
  .grid{display:grid;grid-template-columns: 340px 1fr; gap:18px}
  @media (max-width: 980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:var(--border);border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,.35)}
  .left{padding:16px}
  .right{display:flex;flex-direction:column;overflow:hidden}
  label{display:block;color:var(--muted);font-size:.86rem;margin:10px 0 6px}
  input,select,button,textarea{font:inherit}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:var(--border);background:#0f1425;color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:10px}
  .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:var(--border);background:#10162a;color:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#000;border:0;font-weight:800}
  .btn.ok{background:var(--ok);color:#000;border:0}
  .btn.err{background:var(--err);color:#000;border:0}
  .toolbar{display:flex;gap:10px;align-items:center;padding:12px;border-bottom:var(--border)}
  textarea{flex:1;min-height:520px;border:0;outline:0;background:#0b1020;color:#e8eefc;padding:16px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;line-height:1.45;border-radius:0 0 var(--radius) var(--radius);}
  .status{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;color:var(--muted)}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1528;border:var(--border);color:var(--muted);font-weight:700;font-size:.8rem}
  .hint{font-size:.86rem;color:var(--muted)}
  .danger{color:#ff9a9a}
</style>
</head>
<body>
<header>
  <h1>ðŸŽ¬ FSA Media-Admin â€“ JSON Editor (GitHub Push, kein LocalStorage)</h1>
</header>

<main class="grid">
  <!-- LEFT: Login & File selection -->
  <section class="card left">
    <h3 style="margin:6px 0 12px">Verbindung</h3>
    <label for="owner">Owner / Organisation</label>
    <input id="owner" placeholder="z.B. Adler-FSA">
    <label for="repo">Repository</label>
    <input id="repo" placeholder="z.B. LP-Generator">
    <div class="row">
      <div>
        <label for="branch">Branch</label>
        <input id="branch" value="main">
      </div>
      <div>
        <label for="pathPrefix">Pfad (Ordner)</label>
        <input id="pathPrefix" value="">
      </div>
    </div>

    <label for="token">GitHub Token <span class="danger">(wird NICHT gespeichert)</span></label>
    <input id="token" type="password" placeholder="ghp_...">

    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" id="btnPing">ðŸ”Œ Testen</button>
      <span id="pingRes" class="pill">nicht verbunden</span>
    </div>

    <hr style="margin:16px 0;border:0;border-top:var(--border)">

    <label for="fileSel">Datei</label>
    <select id="fileSel">
      <option value="settings.json">settings.json</option>
      <option value="slideshow.json">slideshow.json</option>
      <option value="rotator.json">rotator.json</option>
      <option value="music.json">music.json</option>
      <option value="reise.json">reise.json</option>
      <option value="emails.json">emails.json</option>
    </select>

    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn" id="btnLoad">ðŸ“¥ Laden</button>
      <button class="btn ok" id="btnSave">ðŸ’¾ Speichern</button>
    </div>

    <p class="hint" style="margin-top:14px">
      â€¢ Ã„nderungen werden per GitHub API als Commit gespeichert<br>
      â€¢ Token bleibt <b>nur im Arbeitsspeicher</b> â€“ kein LocalStorage / keine URL-Parameter<br>
      â€¢ Branch/Ordner bitte korrekt setzen (Standard: <code>main</code> / Root)
    </p>
  </section>

  <!-- RIGHT: Editor -->
  <section class="card right">
    <div class="toolbar">
      <span class="pill" id="currentPath">â€“</span>
      <span class="pill" id="currentSha">sha: â€“</span>
      <div style="flex:1"></div>
      <button class="btn" id="btnFormat">âœ¨ JSON formatieren</button>
      <button class="btn err" id="btnValidate">ðŸ§ª JSON prÃ¼fen</button>
    </div>
    <textarea id="editor" spellcheck="false" placeholder="{
  \"example\": true
}"></textarea>
    <div class="status">
      <span id="msg">Bereit.</span>
      <span id="charCount">0 Zeichen</span>
    </div>
  </section>
</main>

<script>
  // ---- State (nur im RAM) ----
  const S = {
    token: null, owner: "", repo: "", branch: "main", pathPrefix: "",
    shaCache: new Map(), currentFile: "settings.json"
  };

  // ---- Helpers ----
  const $ = s => document.querySelector(s);
  function setMsg(t){ $("#msg").textContent = t; }
  function setPing(ok){ const el=$("#pingRes"); el.textContent = ok ? "verbunden" : "nicht verbunden"; el.style.background = ok ? "#0f2a1f" : "#2a0f0f"; el.style.color = ok ? "#9ef6c4" : "#ff9a9a"; }
  function b64(s){ return btoa(unescape(encodeURIComponent(s))); }
  function de64(b){ return decodeURIComponent(escape(atob(b))); }
  function pathJoin(prefix, file){ if(!prefix) return file; return (prefix.replace(/^\/|\/$/g,"")) + "/" + file; }

  // ---- UI Bindings ----
  $("#owner").addEventListener("input", e=>S.owner=e.target.value.trim());
  $("#repo").addEventListener("input", e=>S.repo=e.target.value.trim());
  $("#branch").addEventListener("input", e=>S.branch=e.target.value.trim());
  $("#pathPrefix").addEventListener("input", e=>S.pathPrefix=e.target.value.trim());
  $("#token").addEventListener("input", e=>S.token=e.target.value.trim());
  $("#fileSel").addEventListener("change", e=>{ S.currentFile = e.target.value; updatePathBadge(); });

  $("#btnPing").addEventListener("click", ping);
  $("#btnLoad").addEventListener("click", loadFile);
  $("#btnSave").addEventListener("click", saveFile);
  $("#btnFormat").addEventListener("click", formatJSON);
  $("#btnValidate").addEventListener("click", validateJSON);
  $("#editor").addEventListener("input", ()=>{ $("#charCount").textContent = ($("#editor").value.length)+\" Zeichen\"; });

  function updatePathBadge(){
    const fullPath = pathJoin(S.pathPrefix, S.currentFile);
    $("#currentPath").textContent = fullPath || "â€“";
    $("#currentSha").textContent = "sha: " + (S.shaCache.get(fullPath) || "â€“");
  }
  updatePathBadge();

  // ---- API Calls ----
  async function gh(url, method=\"GET\", body){
    if(!S.token){ throw new Error(\"Kein Token gesetzt.\"); }
    const res = await fetch(url, {
      method,
      headers: {
        \"Accept\":\"application/vnd.github+json\",
        \"Authorization\":\"Bearer \" + S.token
      },
      body: body ? JSON.stringify(body) : undefined
    });
    if(!res.ok){
      const text = await res.text();
      throw new Error(\"GitHub API Fehler: \" + res.status + \" â€“ \" + text);
    }
    return res.json();
  }

  async function ping(){
    try{
      const j = await gh(\"https://api.github.com/user\");
      setPing(true);
      setMsg(\"Angemeldet als: \" + j.login);
    }catch(e){
      console.error(e);
      setPing(false);
      setMsg(\"Verbindung fehlgeschlagen. PrÃ¼fe Token.\");
    }
  }

  async function loadFile(){
    try{
      const fullPath = pathJoin(S.pathPrefix, S.currentFile);
      const url = \`https://api.github.com/repos/\${encodeURIComponent(S.owner)}/\${encodeURIComponent(S.repo)}/contents/\${encodeURIComponent(fullPath)}?ref=\${encodeURIComponent(S.branch)}\`;
      const j = await gh(url);
      const content = de64(j.content);
      S.shaCache.set(fullPath, j.sha);
      $("#editor").value = content;
      $("#charCount").textContent = ($("#editor").value.length)+\" Zeichen\";
      updatePathBadge();
      setMsg(\"Datei geladen.\");
    }catch(e){
      console.error(e);
      setMsg(\"Laden fehlgeschlagen: \" + e.message);
    }
  }

  async function saveFile(){
    try{
      const fullPath = pathJoin(S.pathPrefix, S.currentFile);
      const url = \`https://api.github.com/repos/\${encodeURIComponent(S.owner)}/\${encodeURIComponent(S.repo)}/contents/\${encodeURIComponent(fullPath)}\`;
      const sha = S.shaCache.get(fullPath) || undefined;
      const raw = $("#editor").value;
      // Validierung
      try{ JSON.parse(raw); }catch(e){ if(!confirm(\"JSON ist nicht valide. Trotzdem committen?\")) return; }
      const body = {
        message: \`chore(admin): update \${fullPath}\`,
        content: b64(raw),
        branch: S.branch,
        sha
      };
      const j = await gh(url, \"PUT\", body);
      S.shaCache.set(fullPath, j.content.sha);
      updatePathBadge();
      setMsg(\"Gespeichert âœ“ Commit: \" + (j.commit && j.commit.sha ? j.commit.sha.slice(0,7) : \"\"));
    }catch(e){
      console.error(e);
      setMsg(\"Speichern fehlgeschlagen: \" + e.message);
    }
  }

  function formatJSON(){
    try{
      const obj = JSON.parse($("#editor").value);
      $("#editor").value = JSON.stringify(obj, null, 2);
      $("#charCount").textContent = ($("#editor").value.length)+\" Zeichen\";
      setMsg(\"Formatiert âœ“\");
    }catch(e){
      setMsg(\"Kein gÃ¼ltiges JSON â€“ Formatierung abgebrochen.\");
    }
  }
  function validateJSON(){
    try{ JSON.parse($("#editor").value); setMsg(\"JSON ist gÃ¼ltig âœ“\"); }
    catch(e){ setMsg(\"JSON ungÃ¼ltig: \" + e.message); }
  }
</script>
</body>
</html>
