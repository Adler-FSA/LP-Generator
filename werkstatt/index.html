<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>⚙️ FSA Werkstatt-Zentrale v1.9.1 · Update-Monitor (Auto-Docs Sync)</title>

<style>
  :root{
    --bg:#0b1220;--panel:#111b2e;--text:#e6edff;
    --muted:#94a3b8;--ok:#22c55e;--warn:#facc15;
    --err:#ef4444;--line:#1e293b;--radius:12px;
    --shadow:0 8px 25px rgba(0,0,0,.35);
  }
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg);color:var(--text);}
  h1{font-size:1.6rem;text-align:center;margin:30px 0;color:#38bdf8;}
  .card{background:var(--panel);max-width:1000px;margin:0 auto 40px;
    padding:24px;border-radius:var(--radius);box-shadow:var(--shadow);}
  .flex{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
  button{background:#2563eb;color:#fff;border:none;padding:10px 16px;
    border-radius:8px;cursor:pointer;font-size:.95rem;}
  button:hover{opacity:.9;}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.9rem;}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;}
  th{color:var(--muted);font-weight:600;text-transform:uppercase;font-size:.75rem;}
  .ok{color:var(--ok);} .warn{color:var(--warn);} .err{color:var(--err);}
  .muted{color:var(--muted);}
  pre{background:#0f172a;padding:12px;border-radius:8px;overflow:auto;font-size:.85rem;}
  a{color:#38bdf8;text-decoration:none;} a:hover{text-decoration:underline;}
</style>
</head>

<body>
<h1>🧭 FSA Werkstatt-Zentrale v1.9.1 · Update-Monitor (Auto-Docs Sync)</h1>

<div class="card">
  <div class="flex">
    <button id="refresh">🔄 Aktualisieren</button>
    <button id="sync">🧩 System synchronisieren</button>
    <button id="testlinks">🧪 Testlinks</button>
    <label style="margin-left:auto;font-size:.9rem;color:var(--muted);">
      Schwelle „veraltet“ :
      <select id="threshold">
        <option value="7">7 Tage</option>
        <option value="14" selected>14 Tage</option>
        <option value="30">30 Tage</option>
      </select>
    </label>
  </div>

  <p style="margin-top:16px;font-size:.9rem;color:var(--muted);">
    Build v2.8.5 + DSGVO-safe • Quelle: <code>/docs/update_index.json</code> (Auto-Switch aktiv)
  </p>

  <table id="table">
    <thead>
      <tr><th>Datei / Seite</th><th>Version</th><th>Zuletzt aktualisiert</th><th>Status</th><th>Aktion</th></tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="5" class="muted">Lade Index …</td></tr>
    </tbody>
  </table>

  <pre id="log"></pre>
</div>

<div class="card" style="margin-top:-20px;">
  <h3 style="margin-top:0;">🧰 Diagnose & Schnellzugriff</h3>
  <div class="flex" style="flex-wrap:wrap;gap:10px;">
    <a href="https://adler-fsa.github.io/Lp-Generator/poststelle/?nocache=1" target="_blank">📬 Poststelle öffnen</a>
    <a href="https://adler-fsa.github.io/Lp-Generator/werkstatt/?nocache=1" target="_blank">🧭 Werkstatt (aktuell)</a>
    <a href="https://adler-fsa.github.io/Lp-Generator/lp-template/?nocache=1" target="_blank">🪶 LP-Template</a>
    <a href="https://adler-fsa.github.io/Lp-Generator/docs/manifest.txt" target="_blank">📜 Manifest</a>
    <a href="https://adler-fsa.github.io/Lp-Generator/docs/update_index.json" target="_blank">🗂️ Update-Index</a>
  </div>
</div>

<footer style="text-align:center;font-size:.8rem;color:var(--muted);padding:20px;">
  © 2025 Finanzielle Souveränitäts Akademie • Werkstatt-Zentrale v1.9.1 aktiv • Auto-Docs Monitor
</footer>

<script>
// === Dynamische Pfaderkennung ======================================
const path = location.pathname.includes('Lp-Generator')
  ? '/Lp-Generator/docs/update_index.json'
  : '/docs/update_index.json';

// === Elemente =======================================================
const rows = document.getElementById('rows');
const log  = document.getElementById('log');
const refreshBtn = document.getElementById('refresh');
const syncBtn = document.getElementById('sync');
const testBtn = document.getElementById('testlinks');
const thresholdSel = document.getElementById('threshold');

// === Laden des Index ================================================
async function loadIndex(){
  log.textContent = "📘 Log gestartet …\n";
  try{
    const res = await fetch(path + '?nocache=' + Date.now());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    renderTable(data);
    log.textContent += `✅ Index geladen: ${path}\n`;
  }catch(err){
    rows.innerHTML = `<tr><td colspan="5" class="err">❌ Konnte Index nicht laden: ${err.message}</td></tr>`;
    log.textContent += `❌ Fehler: ${err.message}\nPfad: ${path}\n`;
  }
}

// === Tabelle anzeigen ==============================================
function renderTable(data){
  if(!data || !Array.isArray(data.pages)){
    rows.innerHTML = `<tr><td colspan="5" class="muted">Kein gültiger Index gefunden – Poststelle ausführen.</td></tr>`;
    return;
  }
  const threshold = parseInt(thresholdSel.value);
  const now = Date.now();
  rows.innerHTML = data.pages.map(p=>{
    const diff = (now - new Date(p.lastUpdated).getTime()) / 86400000;
    let statusClass = diff > threshold ? 'warn' : 'ok';
    let statusText = diff > threshold ? 'veraltet' : 'aktuell';
    return `<tr>
      <td>${p.file}</td>
      <td>${p.version}</td>
      <td>${p.lastUpdated}</td>
      <td class="${statusClass}">${statusText}</td>
      <td><a href="${p.link}" target="_blank">Öffnen</a></td>
    </tr>`;
  }).join('');
}

// === Buttons ========================================================
refreshBtn.onclick = ()=>loadIndex();
syncBtn.onclick = ()=>window.open('https://adler-fsa.github.io/Lp-Generator/poststelle/?nocache=1','_blank');
testBtn.onclick = ()=>{
  log.textContent += "\n🧪 Testlinks:\n";
  ['poststelle','werkstatt','lp-template','docs/manifest.txt','docs/update_index.json']
  .forEach(x=>log.textContent += `🔗 https://adler-fsa.github.io/Lp-Generator/${x}/\n`);
};

// === Auto-Reload ====================================================
setInterval(loadIndex, 60000); // jede Minute neu laden
loadIndex();
</script>
</body>
</html>
