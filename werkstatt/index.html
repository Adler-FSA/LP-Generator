<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FSA Werkstatt-Zentrale v1.2</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f1a2b;--muted:#c8d4e4;--link:#7ec8ff;--ok:#00d084;--warn:#ffd166;--err:#ff6b6b;--accent:#3fa3ff;
      --border:rgba(255,255,255,.08);--shadow:0 10px 30px rgba(0,0,0,.35);--pill:#16253a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#e9f1ff;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:48px auto;padding:0 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:22px}
    h1{margin:0 0 14px;font-weight:800;letter-spacing:.2px}
    .sub{opacity:.75;margin-bottom:18px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
    th{font-weight:700;text-align:left;opacity:.9}
    .mcol{width:170px}
    .acol{width:160px}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);background:#163058;border-radius:10px;color:#e9f1ff;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#1a4d86;border-color:#2d69ad}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
    .log{font:12.5px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0c1626;border:1px solid var(--border);border-radius:10px;padding:12px;height:132px;overflow:auto}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:18px 0}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#123456;border:1px solid var(--border);margin-left:8px;opacity:.9}
    /* Log-Reader */
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0 12px}
    .table{background:#0e1a2b;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .tr{display:grid;grid-template-columns:160px 1fr 100px;gap:0;border-bottom:1px solid var(--border)}
    .th{background:#0e213a;font-weight:700}
    .cell{padding:10px 12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#12243b}
    .tag.ok{color:var(--ok)} .tag.warn{color:var(--warn)} .tag.err{color:var(--err)}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:16px">
      <h1>üõ†Ô∏è FSA Werkstatt-Zentrale v1.2</h1>
      <div class="sub">Autonome Freigabe- und Diagnoseeinheit ‚Äî integriert mit Poststelle &amp; LP-Generator. <span class="badge" id="buildBadge">Build v2.7.5+</span></div>

      <div class="grid two" style="margin-top:8px">
        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">Module</div>
          <table>
            <thead><tr><th>Modul</th><th class="mcol">Status</th><th class="acol">Aktion</th></tr></thead>
            <tbody>
              <tr><td>üìÆ Poststelle</td><td><span class="status ok">aktiv</span></td><td><a href="/Lp-Generator/poststelle/" target="_blank">√ñffnen</a></td></tr>
              <tr><td>üß† Patch-Manager</td><td><span class="status ok">aktiv</span></td><td><a href="/Lp-Generator/tools/patch-manager.html" target="_blank">Code</a></td></tr>
              <tr><td>‚úèÔ∏è LP-Generator</td><td><span class="status ok">aktiv</span></td><td><a href="/Lp-Generator/lp-template.html" target="_blank">Template</a></td></tr>
              <tr><td>üóÉÔ∏è Backup-Archiv</td><td><span class="status ok">aktiv</span></td><td><a href="/Lp-Generator/README.md" target="_blank">Info</a></td></tr>
            </tbody>
          </table>

          <div class="hr"></div>

          <div style="font-weight:700;margin-bottom:6px">Eingehende Patches</div>
          <ul style="margin:0 0 12px 18px">
            <li>‚úâÔ∏è E-Mail-Feld inkl. Vor-/Nachnamen (LP-Template)</li>
            <li>üß≠ Men√ºleiste ohne ‚ÄûKino‚Äú-Modul</li>
          </ul>

          <button id="sync" class="btn primary">üîÑ System synchronisieren</button>

          <div class="log" id="syslog" style="margin-top:12px">Log ge√∂ffnet ‚Ä¶</div>
        </div>

        <div class="card">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <div style="font-weight:700">üìä Diagnose-Log-Reader</div>
            <span class="pill">Quelle: <code class="mono">/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt</code></span>
            <span class="right muted" id="autoInfo">Auto-Refresh: aus</span>
          </div>

          <div class="toolbar">
            <button id="refresh" class="btn">‚Üª Aktualisieren</button>
            <button id="toggleAuto" class="btn">‚ñ∂Ô∏é Auto-Refresh</button>
            <span class="muted">Zeige letzte <span id="limitView">50</span> Eintr√§ge</span>
          </div>

          <div class="table" id="logTable">
            <div class="tr th">
              <div class="cell">Zeit</div>
              <div class="cell">Ereignis</div>
              <div class="cell">Status</div>
            </div>
            <!-- rows injected here -->
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">FSA Werkstatt-System | TOKEN-CONTROL aktiv</div>
    </div>
  </div>

  <script>
  (function(){
    const syslog = document.getElementById('syslog');
    const log = (m)=>{ syslog.textContent += (syslog.textContent ? "\\n" : "") + m; syslog.scrollTop = syslog.scrollHeight; };

    // --- Verbindungstest / simple Sync-Flow ---
    document.getElementById('sync').onclick = async ()=>{
      log("üß∞ Werkstatt gestartet ‚Ä¶");
      try{
        log("üîå Verbindung zur Poststelle pr√ºfen ‚Ä¶");
        const res = await fetch('/Lp-Generator/poststelle/index.html', {method:'HEAD'});
        if(!res.ok) throw new Error("Poststelle antwortet nicht");
        log("‚úÖ Poststelle erreichbar.");
        log("üß† Synchronisation mit LP-Generator ‚Ä¶");
        setTimeout(()=>{ log("üü¢ LP-Generator verbunden."); alert("‚úÖ Alle Module aktuell.\\n\\nSynchronisation erfolgreich abgeschlossen."); }, 800);
      }catch(e){
        log("‚ùå Fehler: "+e.message);
        alert("Fehler bei der Synchronisation: "+e.message);
      }
    };

    // --- Diagnose-Log-Reader v1.0 ---
    const LOG_URL = '/Lp-Generator/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt';
    const table = document.getElementById('logTable');
    const limitView = document.getElementById('limitView');
    const autoInfo = document.getElementById('autoInfo');
    const btnRefresh = document.getElementById('refresh');
    const btnAuto = document.getElementById('toggleAuto');
    let timer = null, limit = 50;

    function statusFrom(text){
      // Heuristik: erkenne Status √ºber Emojis/W√∂rter
      if(/[‚úÖüü¢]|\bok\b|freigegeben|installiert/i.test(text)) return {cls:'ok', label:'OK'};
      if(/[‚ö†Ô∏èüü°]|\bwarn/i.test(text)) return {cls:'warn', label:'Hinweis'};
      if(/[‚ùåüî¥]|\bfehler|error/i.test(text)) return {cls:'err', label:'Fehler'};
      return {cls:'', label:'‚Äî'};
    }
    function tsFrom(line){
      // Versuche Datum/Uhrzeit am Zeilenanfang zu greifen ‚Äì ansonsten "‚Äì"
      const m = line.match(/^(\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}(?::\d{2})?)/);
      return m ? m[1].replace('T',' ') : '‚Äì';
    }
    function row(ts, msg, st){
      const div = document.createElement('div');
      div.className='tr';
      div.innerHTML = `
        <div class="cell mono">${ts}</div>
        <div class="cell">${msg}</div>
        <div class="cell"><span class="tag ${st.cls}">${st.label}</span></div>`;
      return div;
    }
    async function loadLog(){
      try{
        const res = await fetch(LOG_URL + '?nocache=' + Date.now());
        if(!res.ok) throw new Error('Log nicht erreichbar');
        const txt = await res.text();
        const lines = txt.split(/\r?\n/).filter(Boolean);
        const slice = lines.slice(-limit).reverse();
        // clear old rows
        [...table.querySelectorAll('.tr.data')].forEach(n=>n.remove());
        // render
        slice.forEach(line=>{
          const st = statusFrom(line);
          const ts = tsFrom(line);
          const r = row(ts, line.replace(/^(\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}(?::\d{2})?)\s*-?\s*/,'')
                                 .replace(/[\\u001b\\[\\d;]*m/g,''), st);
          r.classList.add('data');
          table.appendChild(r);
        });
      }catch(e){
        // Fallback-Zeile mit Fehler
        [...table.querySelectorAll('.tr.data')].forEach(n=>n.remove());
        const r = row('‚Äì', 'Log konnte nicht geladen werden: '+e.message, {cls:'err', label:'Fehler'});
        r.classList.add('data');
        table.appendChild(r);
      }
    }
    btnRefresh.onclick = loadLog;
    btnAuto.onclick = ()=>{
      if(timer){ clearInterval(timer); timer=null; btnAuto.textContent='‚ñ∂Ô∏é Auto-Refresh'; autoInfo.textContent='Auto-Refresh: aus'; }
      else { timer=setInterval(loadLog, 15000); btnAuto.textContent='‚è∏ Auto-Refresh'; autoInfo.textContent='Auto-Refresh: 15s'; loadLog(); }
    };
    // initial
    loadLog();

    // Build-Badge dynamisch ausgeben (optional)
    try{
      document.getElementById('buildBadge').textContent = 'Build v1.2 ‚Ä¢ Reader aktiv';
    }catch{}
  })();
  </script>
</body>
</html>
