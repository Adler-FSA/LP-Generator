<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, initial-scale=1" />
  <title>FSA Werkstatt-Zentrale v1.8</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0f1b2d;--muted:#b8c7e0;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --link:#7dd3fc;--ink:#e5edff;--line:#1e2a44;--badge:#17233a;--accent:#60a5fa;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:40px auto;padding:16px}
    .head{display:flex;align-items:center;gap:12px;margin:8px 0 18px}
    .head h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .grid{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.18)}
    .card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .hd h2{margin:0;font-size:16px}
    .card .bd{padding:16px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--badge);border:1px solid var(--line);border-radius:20px;padding:6px 10px}
    .s-ok{color:var(--ok)} .s-warn{color:var(--warn)} .s-err{color:var(--err)} .s-muted{color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--line);background:#122441;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#274068}
    .btn.primary{background:#143054;border-color:#1e4a83}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    textarea.log{width:100%;min-height:140px;background:#0b1526;border:1px solid var(--line);border-radius:8px;color:var(--ink);padding:10px}
    .kvs{display:grid;grid-template-columns:150px 1fr;gap:10px;margin:8px 0}
    .copy{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#13233f;color:var(--ink);cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#13233f;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
    .footer{margin:18px 0;color:var(--muted);font-size:12px}
    @media (max-width:700px){ .kvs{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 7h18M6 7l2 12h8l2-12" stroke="#7dd3fc" stroke-width="1.5"/><path d="M9 7V5a3 3 0 0 1 6 0v2" stroke="#7dd3fc" stroke-width="1.5"/></svg>
      <h1>FSA Werkstatt-Zentrale v1.8</h1>
    </div>
    <div class="sub">Autonome Freigabe- & Diagnoseeinheit ¬∑ <span class="s-muted">Build v2.7.7+ ¬∑ Smart-Checker ¬∑ Auto-Deploy-History ¬∑ Diagnose-Sync</span></div>

    <!-- MODULE -->
    <div class="card">
      <div class="hd"><h2>Module</h2></div>
      <div class="bd">
        <table class="table">
          <thead><tr><th>Modul</th><th>Status</th><th>Aktion</th></tr></thead>
          <tbody>
            <tr><td>üìÆ Poststelle</td><td><span class="s-ok">aktiv</span></td><td><a href="https://adler-fsa.github.io/Lp-Generator/poststelle/" target="_blank">√ñffnen</a></td></tr>
            <tr><td>üß† Patch-Manager</td><td><span class="s-ok">aktiv</span></td><td><a href="https://adler-fsa.github.io/Lp-Generator/tools/patch-manager.html" target="_blank">Code</a></td></tr>
            <tr><td>‚úíÔ∏è LP-Generator</td><td><span class="s-ok">aktiv</span></td><td><a href="https://adler-fsa.github.io/Lp-Generator/lp-template.html" target="_blank">Template</a></td></tr>
            <tr><td>üì¶ Backup-Archiv</td><td><span class="s-ok">aktiv</span></td><td><a href="https://adler-fsa.github.io/Lp-Generator/BACKUP_INFO.txt" target="_blank">Info</a></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- COMMIT RULE 3.0 -->
    <div class="card">
      <div class="hd"><h2>Commit-Regelhilfe 3.0</h2></div>
      <div class="bd">
        <div class="chips" style="margin-bottom:10px">
          <span class="chip">1) Pfadangaben</span>
          <span class="chip">2) Commit-Nachrichten</span>
          <span class="chip">3) Upload-Reihenfolge</span>
          <span class="chip">4) Test-Schritte</span>
          <span class="chip">5) Bereitstellung</span>
        </div>

        <div class="kvs">
          <div class="s-muted">Commit Message</div>
          <div class="row">
            <input id="cm" class="mono" style="flex:1;min-width:300px;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0b1526;color:var(--ink)" value="Werkstatt-Zentrale v1.8 ‚Äì Smart-Checker + Auto-Deploy-History + Diagnose-Sync" />
            <button class="copy" data-copy="#cm">kopieren</button>
          </div>

          <div class="s-muted">Beschreibung</div>
          <div class="row">
            <textarea id="cd" class="mono" style="flex:1;min-height:90px;border-radius:8px;background:#0b1526;border:1px solid var(--line);color:var(--ink)">Adds Smart-Checker (erkennt HTML/404/Timeout & zeigt Klartext), Auto-Deploy-History (liest letzte Ereignisse aus /docs/diagnose_log/FSA_DIAGNOSE_LOG.txt), Diagnose-Sync und aktive Testlinks. DSGVO-safe (kein persistenter Storage, nur Reads + optionale Session-Sync).</textarea>
            <button class="copy" data-copy="#cd">kopieren</button>
          </div>
        </div>
      </div>
    </div>

    <!-- AUTO-DEPLOY STATUS -->
    <div class="card">
      <div class="hd">
        <h2>Auto-Deploy Status</h2>
        <div class="row">
          <button id="check" class="btn">Version jetzt pr√ºfen</button>
          <a class="btn primary" href="https://adler-fsa.github.io/Lp-Generator/poststelle/?nocache=1" target="_blank">Poststelle testen</a>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:8px">
          <div class="pill">Quelle: <span class="mono" id="src">/Lp-Generator/poststelle/</span></div>
          <div class="pill">Ergebnis: <span id="res" class="s-muted">‚Äì</span></div>
        </div>
        <textarea id="raw" class="log mono" placeholder="Antwort der Quelle ‚Ä¶"></textarea>
      </div>
    </div>

    <!-- DEPLOY HISTORY + DIAGNOSE -->
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="card">
        <div class="hd">
          <h2>Auto-Deploy-History</h2>
          <div class="row">
            <button id="histRefresh" class="btn">Aktualisieren</button>
            <button id="histAuto" class="btn">Auto-Refresh: aus</button>
          </div>
        </div>
        <div class="bd">
          <div class="s-muted" style="margin-bottom:6px">Quelle (read-only): <span class="mono">/Lp-Generator/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt</span></div>
          <table class="table" id="hist">
            <thead><tr><th>Zeit</th><th>Ereignis</th><th>Status</th></tr></thead>
            <tbody><tr><td colspan="3" class="s-muted">Lade ‚Ä¶</td></tr></tbody>
          </table>
          <div class="row" style="margin-top:8px">
            <a class="btn" target="_blank" href="https://adler-fsa.github.io/Lp-Generator/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt">Log im neuen Tab √∂ffnen</a>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>Aktive Testlinks</h2></div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <a class="btn" target="_blank" href="https://adler-fsa.github.io/Lp-Generator/werkstatt/">Werkstatt √∂ffnen</a>
            <a class="btn" target="_blank" href="https://adler-fsa.github.io/Lp-Generator/poststelle/">Poststelle √∂ffnen</a>
            <a class="btn" target="_blank" href="https://adler-fsa.github.io/Lp-Generator/lp-template.html">LP-Template √∂ffnen</a>
          </div>
          <div class="s-muted">Hinweis: Links sind √∂ffentlich lesbar; es werden keine Tokens, PII oder persistente Daten verwendet.</div>
        </div>
      </div>
    </div>

    <div class="footer">¬© 2025 Finanzielle Souver√§nit√§ts Akademie ¬∑ Werkstatt-Zentrale v1.8 ¬∑ Smart-Checker & History aktiv</div>
  </div>

  <script>
    // --- helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    $$(".copy").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const inp = document.querySelector(btn.dataset.copy);
        inp.select?.(); inp.setSelectionRange?.(0, 99999);
        navigator.clipboard.writeText(inp.value || inp.textContent || "");
        btn.textContent = "kopiert";
        setTimeout(()=>btn.textContent="kopieren",1200);
      });
    });

    // --- Smart Checker (Poststelle-Version)
    async function smartCheck(){
      const resEl = $("#res"); const raw = $("#raw");
      raw.value = ""; resEl.textContent = "pr√ºfe ‚Ä¶"; resEl.className = "s-muted";
      try{
        const url = "https://adler-fsa.github.io/Lp-Generator/poststelle/";
        const r = await fetch(url, { method:"GET", cache:"no-store" });
        const ctype = r.headers.get("content-type") || "";
        const text = await r.text();
        raw.value = text.substring(0, 5000);

        // if JSON & has version
        if(ctype.includes("application/json")){
          try{
            const j = JSON.parse(text);
            if(j.version){ resEl.textContent = "Poststelle " + j.version; resEl.className="s-ok"; return; }
          }catch(_){}
        }

        // HTML fallback or 404 markup
        if(ctype.includes("text/html") || text.includes("<!DOCTYPE")){
          resEl.textContent = "Version unbekannt (HTML/404-Fallback)";
          resEl.className = "s-warn";
          return;
        }

        resEl.textContent = "Unbekannte Antwort (kein JSON/HTML)";
        resEl.className = "s-warn";
      }catch(e){
        $("#raw").value = String(e);
        $("#res").textContent = "Fehler beim Abruf";
        $("#res").className = "s-err";
      }
    }
    $("#check").addEventListener("click", smartCheck);
    // auto-run on load (non-blocking)
    setTimeout(smartCheck, 300);

    // --- History (Diagnose-Log)
    const LOG_URL = "https://adler-fsa.github.io/Lp-Generator/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt";
    let auto = false, autoTimer=null;

    function parseLog(txt){
      const rows = [];
      const lines = txt.split(/\r?\n/).filter(Boolean).slice(-50); // last 50
      for(const ln of lines){
        // expected formats (tolerant):
        // 2025-10-08 09:50 | Patch v2.7.7 ausgel√∂st. | ok
        // 2025-10-08 09:51 | Werkstatt v1.7 Auto-Deploy ausgel√∂st. | ok
        const m = ln.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2})\s*\|\s*(.+?)\s*\|\s*(ok|err|warn)$/i);
        if(m) rows.push({ t:m[1], msg:m[2], st:m[3].toLowerCase() });
        else  rows.push({ t:"‚Äì", msg:ln, st:"warn" });
      }
      return rows;
    }

    async function loadHistory(){
      const tbody = $("#hist tbody");
      tbody.innerHTML = `<tr><td colspan="3" class="s-muted">Lade ‚Ä¶</td></tr>`;
      try{
        const r = await fetch(LOG_URL, { cache:"no-store" });
        if(!r.ok){ throw new Error(r.status+" "+r.statusText); }
        const txt = await r.text();
        const rows = parseLog(txt);
        if(!rows.length){ tbody.innerHTML = `<tr><td colspan="3" class="s-muted">Keine Eintr√§ge</td></tr>`; return; }
        tbody.innerHTML = rows.reverse().slice(0,15).map(x=>{
          const cls = x.st==="ok"?"s-ok":(x.st==="err"?"s-err":"s-warn");
          return `<tr><td class="mono">${x.t}</td><td>${x.msg}</td><td class="${cls}">${x.st.toUpperCase()}</td></tr>`;
        }).join("");
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="3" class="s-err">Log konnte nicht geladen werden (${e.message})</td></tr>`;
      }
    }
    $("#histRefresh").addEventListener("click", loadHistory);
    $("#histAuto").addEventListener("click", ()=>{
      auto = !auto;
      $("#histAuto").textContent = "Auto-Refresh: " + (auto?"an":"aus");
      if(auto){ loadHistory(); autoTimer = setInterval(loadHistory, 8000); }
      else{ clearInterval(autoTimer); }
    });
    // first load
    loadHistory();

    // Session-Sync (optional, DSGVO-safe: tab-lokal)
    try{
      sessionStorage.setItem("FSA_WERKSTATT_PING","1");
    }catch{}
  </script>
</body>
</html>
