<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FSA Werkstatt-Zentrale v1.9 ¬∑ Update-Monitor</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#101a2b;--text:#e6f2ff;--muted:#9db4cc;
      --ok:#1fdf64;--warn:#ffbd2e;--err:#ff4d4d;--cold:#7a8aa0;--line:#14233a;
      --btn:#2486ff;--btn2:#1f6edc;--chip:#0f2138;
      --shadow:0 8px 28px rgba(0,0,0,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --round:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#09101e 0%,#0b1220 100%);
      color:var(--text);font-family: system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif;}
    .wrap{max-width:1100px;margin:40px auto 80px;padding:0 20px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--round);box-shadow:var(--shadow)}
    .head{padding:22px 24px;border-bottom:1px solid var(--line);display:flex;gap:18px;align-items:center}
    .head h1{margin:0;font-size:22px}
    .tag{font-size:12px;color:var(--muted);padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--chip)}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .controls{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap}
    button, .btn{
      appearance:none;border:0; border-radius:10px; padding:10px 14px; cursor:pointer;
      background:var(--btn); color:white; font-weight:600; box-shadow:0 4px 14px rgba(36,134,255,.25);
    }
    button.secondary{background:#132641;color:#cfe3ff;border:1px solid var(--line)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:top}
    th{color:#cfe3ff;text-align:left;font-weight:700;background:#0f1a2c;position:sticky;top:0}
    tr:hover td{background:#0f1a2c}
    .mono{font-family:var(--mono);font-size:12px}
    .grid{padding:10px 12px}
    .status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .g{background:rgba(31,223,100,.08); color:var(--ok); }
    .y{background:rgba(255,189,46,.08); color:var(--warn); }
    .r{background:rgba(255,77,77,.08); color:var(--err); }
    .s{background:rgba(122,138,160,.08); color:var(--cold); }
    .pill{font-size:11px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1d33;color:#cfe3ff}
    a{color:#6bb3ff;text-decoration:none}
    a:hover{text-decoration:underline}
    .footer{margin-top:16px;color:#9db4cc;font-size:12px}
    .log{white-space:pre-wrap;background:#0e1a2e;border-top:1px solid var(--line);padding:12px;border-radius:0 0 var(--round) var(--round);max-height:220px;overflow:auto}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1>üõ†Ô∏è FSA Werkstatt-Zentrale v1.9 ¬∑ Update-Monitor</h1>
        <span class="tag">Build v2.7.8+ ¬∑ DSGVO-safe</span>
        <span class="right tag">Quelle: <code class="mono">/docs/update_index.json</code></span>
      </div>

      <div class="controls">
        <div class="inline">
          <button id="btnRefresh">Aktualisieren</button>
          <button id="btnSync" class="secondary" title="Werkstatt ‚Üî Poststelle & LP-Generator">System synchronisieren</button>
        </div>
        <div class="inline">
          <label class="muted">Schwelle ‚Äûveraltet‚Äú:
            <select id="thresh">
              <option value="7">7 Tage</option>
              <option value="14" selected>14 Tage</option>
              <option value="30">30 Tage</option>
            </select>
          </label>
        </div>
        <div class="inline">
          <span class="pill">üü¢ aktuell</span>
          <span class="pill">üü° veraltet</span>
          <span class="pill">‚ö™ nie</span>
          <span class="pill">üî¥ Fehler</span>
        </div>
        <div class="right inline">
          <button id="btnOpenPost" class="secondary" onclick="openLink('/Lp-Generator/poststelle/')">Poststelle √∂ffnen</button>
          <button class="secondary" onclick="openLink('/Lp-Generator/lp-template.html')">LP-Template √∂ffnen</button>
        </div>
      </div>

      <div class="grid">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:34%">Datei / Seite</th>
              <th style="width:14%">Version</th>
              <th style="width:18%">Zuletzt aktualisiert</th>
              <th style="width:12%">Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="muted">Lade Index ‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="log mono" id="log">Log ge√∂ffnet ‚Ä¶</div>
    </div>

    <div class="footer">
      ¬© 2025 Finanzielle Souver√§nit√§ts Akademie ¬∑ Werkstatt-Zentrale v1.9 ¬∑ Update-Monitor aktiv
    </div>
  </div>

<script>
(() => {
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const log = (m) => { const el = $("#log"); el.textContent += "\\n" + m; el.scrollTop = el.scrollHeight; };

  const SRC = "/docs/update_index.json";           // Auto-Writer der Poststelle
  const FALLBACK_SRC = "/docs/diagnose_log/FSA_DIAGNOSE_LOG.txt"; // Nur Info, nicht gerendert
  let thresholdDays = 14;

  $("#thresh").addEventListener("change", e => {
    thresholdDays = parseInt(e.target.value,10);
    render(window.__DATA || []);
  });

  $("#btnRefresh").addEventListener("click", () => load());
  $("#btnSync").addEventListener("click", () => {
    log("üîó Synchronisation angesto√üen (simuliert) ‚Ä¶");
    // Platzhalter ‚Äì echte Syncs √ºbernehmen Poststelle & Auto-Deploy
    setTimeout(()=>log("‚úÖ Sync ok ‚Äì Komponenten verbunden."),700);
  });

  window.openLink = (path) => window.open(path, "_blank","noopener");

  function statusBadge(ts, err){
    if (err) return `<span class="status r">üî¥ Fehler</span>`;
    if (!ts) return `<span class="status s">‚ö™ nie</span>`;
    const age = (Date.now() - ts)/86400000;
    if (age <= thresholdDays) return `<span class="status g">üü¢ aktuell</span>`;
    return `<span class="status y">üü° veraltet</span>`;
  }

  function fmt(ts){
    if(!ts) return "‚Äì";
    const d = new Date(ts);
    return d.toLocaleString("de-DE");
  }

  function linkify(p){ return `<a href="${p}" target="_blank" rel="noopener">${p}</a>`; }

  function render(rows){
    const tb = $("#tbody"); tb.innerHTML = "";
    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">Kein Index gefunden. Poststelle ausf√ºhren, damit <code class="mono">${SRC}</code> erzeugt/aktualisiert wird.</td></tr>`;
      return;
    }
    rows.sort((a,b)=> (b.updated_ts||0)-(a.updated_ts||0));
    for (const r of rows){
      const repo = r.repo_path ? `<a href="https://github.com/${r.repo_path}" target="_blank" rel="noopener">Repo</a>` : "‚Äî";
      const live = r.live_url ? `<a href="${r.live_url}" target="_blank" rel="noopener">√ñffnen</a>` : "‚Äî";
      const hist = r.history_url ? `<a href="${r.history_url}" target="_blank" rel="noopener">History</a>` : "‚Äî";
      const act = [live, repo, hist].join(" ¬∑ ");
      const ver = r.version ? `<span class="pill">v${r.version}</span>` : "‚Äî";
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><div><strong>${r.name||"Unbenannt"}</strong><div class="mono muted">${linkify(r.path||"")}</div></div></td>
        <td>${ver}</td>
        <td>${fmt(r.updated_ts)}</td>
        <td>${statusBadge(r.updated_ts, r.error)}</td>
        <td>${act}</td>`;
      tb.appendChild(row);
    }
  }

  async function load(){
    $("#btnRefresh").disabled = true;
    log("üì• Lade Index: " + SRC);
    try{
      const res = await fetch(SRC, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      if (!Array.isArray(json)) throw new Error("Unerwartetes Format");
      window.__DATA = json.map(x=>{
        // Harmonisierung (robust gegen verschiedene Writer-Versionen)
        return {
          name: x.name || x.title || x.path?.split("/").pop(),
          path: x.path || x.file || "",
          version: (x.version||"").toString().replace(/^v/i,""),
          updated_ts: x.updated_ts || (x.updated ? Date.parse(x.updated) : 0),
          live_url: x.live_url || x.url || "",
          repo_path: x.repo_path || "",
          history_url: x.history_url || ""
        };
      });
      log("‚úÖ Index geladen ("+window.__DATA.length+" Eintr√§ge).");
      render(window.__DATA);
    }catch(e){
      log("‚ùå Konnte Index nicht laden: "+e.message);
      render([]);
    }finally{
      $("#btnRefresh").disabled = false;
    }
  }

  // Auto-Start
  load();
})();
</script>
</body>
</html>
